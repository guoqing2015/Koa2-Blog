<% include header %>
<% include sidebar %>
<div id="app-container">
    <button class="category-add" data-categoryid="0">新增分类</button>
    <h2>分类列表</h2>
    <ul>
        <li>
            <p>
                <button class="category-add" data-categoryid="11">新增子分类</button>
                <button class="category-delete" data-categoryid="33">删除</button>
            </p>
        </li>
    </ul>
</div>

<script>
    $(function () {

        function getCategories() {
            $.ajax({
                url: '/categories/query',
                type: 'get',
                dataType: 'json',
                data: {},
                success: function (msg) {
                    console.log(msg);
                    if (msg.result) {
                        var categories = msg.categories;

                        var partitionCategories = _.partition(categories, function (v) {
                            return v.parent_id == 0
                        });

                        console.log('partitionCategories', partitionCategories)
                        var firstCategories = partitionCategories[0];
                        var otherCategories = partitionCategories[1];

                        console.log('categories', categories)

                        _.map(firstCategories, function (v) {
                            v.children = [];
                            return v;
                        });
                        // console.log('firstCategories', firstCategories)

                    } else {}
                },
                error: function () {}
            })
        }

        getCategories();


        $(".category-add").click(function () {
            var categoryname = window.prompt("输入分类名称");
            var categoryId = $(this).attr("data-categoryid");

            if (categoryname != null && categoryname != "") {

                $.ajax({
                    url: '/category/create',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        name: categoryname,
                        parent_id: categoryId || 0
                    },
                    // processData: false,
                    // contentType: false,
                    success: function (msg) {
                        console.log(msg);
                        if (msg.result) {
                            location.reload();
                        } else {
                            alert('新增失败')
                        }
                    },
                    error: function () {
                        alert('新增异常');
                    }
                })
            }
        });



        $(".category-delete").bind('click', function () {
            var categoryId = $(this).attr("data-categoryid");
            $.ajax({
                url: '/category/delete',
                type: 'POST',
                dataType: 'json',
                data: {
                    id: categoryId,
                },
                // processData: false,
                // contentType: false,
                success: function (msg) {
                    console.log(msg);
                    if (msg.result) {
                        location.reload();
                    } else {
                        alert('删除失败')
                    }
                },
                error: function () {
                    alert('删除异常');
                }
            })
        });
    })
</script>
<% include footer %>